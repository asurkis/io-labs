# Лабораторная работа 3

**Название:** "Разработка драйверов сетевых устройств"

**Цель работы:** 

## Описание функциональности драйвера

Драйвер должен создавать виртуальный сетевой интерфейс в ОС Linux. Созданный сетевой интерфейс должен перехватывать пакеты родительского интерфейса и реализовывать логику работы с перехваченным трафиком в соответствии с заданиями по вариантам. Должна иметься возможность просмотра статистики работы созданного интерфейса.

**Вариант 2:**

- Пакеты протокола IPv4, адресуемые конкретному IP. Вывести IP адреса отправителя и получателя.
- Состояние разбора пакетов необходимо выводить в файл в директории /proc


## Инструкция по сборке

1. Собрать проект при помощи `make`.
2. `insmod lab2.ko` - загрузка модуля в ядро.
3. `rmmod lab2` - выгрузка модуля.

## Инструкция пользователя

1. `dmesg` - вывод сообщений ядра, просмотр информации о перехвате пакетов IPv4 с указанием адресов отправителя и получателя.
2. `ping -4 <адрес получателя>` - передача IPv4 пакетов.
3. `cat /proc/var2` - вывод информации о разборе пакетов.
4. `ip -s link show <имя устройства>` - статистика работы сетевого устройства.

## Примеры использования

Вывод кольцевого буфера после загрузки модуля:

`dmesg` 

```
[ 3462.431812] Module lab3 loaded
[ 3462.431813] lab3: create link vni0
[ 3462.431814] lab3: registered rx handler for enp0s3
[ 3462.519239] IPv6: ADDRCONF(NETDEV_UP): vni0: link is not ready
[ 3462.519275] vni0: device opened
```
Работа сетевого интерфейса, перехватывающего все IPv4 пакеты, значительно ограничивает передачу и получение данных пользователем. Так, например, при использовании ping не будет получен Echo-Reply:

`ping -4 -c 2 -I lo 127.0.0.12` - отправка двух пакетов. 

```
PING 127.0.0.12 (127.0.0.12) from 127.0.0.1 lo: 56(84) bytes of data.

--- 127.0.0.12 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1020ms
```

Вывод кольцевого буфера после перехвата пакетов:

`dmesg` 

```
[ 3532.034186] Captured IPv4 frame, saddr: 127.0.0.1, daddr: 127.0.0.12
[ 3533.058234] Captured IPv4 frame, saddr: 127.0.0.1, daddr: 127.0.0.12
```

`cat /proc/var2`

```
rx_packets : 2
rx_bytes : 168
tx_packets : 0
tx_bytes : 0
```
`ip -s link show vni0`

```
3: vni0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 1000
link/ether 08:00:27:6c:a8:f8 brd ff:ff:ff:ff:ff:ff
RX: bytes packets errors dropped overrun mcast
    22938   239      0      0       0      0
TX: bytes packets errors dropped carrier collsns
      0      0      0       0       0      0
```
